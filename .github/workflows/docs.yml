# Documentation Workflow
# Builds rustdoc and opens PR to deploy to zircote.github.io/subcog/

name: Documentation

on:
  push:
    branches: [develop, main]
    paths:
      - 'src/**'
      - 'Cargo.toml'
      - 'Cargo.lock'
      - '.github/workflows/docs.yml'
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

concurrency:
  group: docs
  cancel-in-progress: false

env:
  CARGO_TERM_COLOR: always

jobs:
  build:
    name: Build Documentation
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@f7ccc83f9ed1e5b9c81d8a67d7ad1a747e22a561 # nightly
        with:
          toolchain: nightly

      - name: Cache cargo registry
        uses: actions/cache@1bd1e32a3bdc45362d1e726936510720a7c30a57 # v4.2.0
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-docs-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-docs-

      - name: Build documentation
        run: cargo doc --no-deps --all-features --document-private-items

      - name: Create index redirect
        run: |
          echo '<meta http-equiv="refresh" content="0; url=subcog/index.html">' > target/doc/index.html

      - name: Add .nojekyll
        run: touch target/doc/.nojekyll

      - name: Upload artifact
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.1
        with:
          name: docs
          path: target/doc

  deploy:
    name: Open PR to zircote.github.io
    needs: build
    runs-on: ubuntu-latest
    environment: copilot
    steps:
      - name: Download docs artifact
        uses: actions/download-artifact@fa0a91b85d4f404e444e00e005971372dc801d16 # v4.1.8
        with:
          name: docs
          path: docs

      - name: Checkout zircote.github.io
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          repository: zircote/zircote.github.io
          token: ${{ secrets.ZIRCOTE_GH_PAGES_TOKEN }}
          path: site

      - name: Create branch and update docs
        id: update
        env:
          SOURCE_SHA: ${{ github.sha }}
        run: |
          cd site

          # Create unique branch name
          BRANCH="docs/subcog-${SOURCE_SHA:0:7}"
          echo "branch=$BRANCH" >> "$GITHUB_OUTPUT"

          # Check if branch already exists
          if git ls-remote --heads origin "$BRANCH" | grep -q "$BRANCH"; then
            echo "Branch $BRANCH already exists, skipping"
            echo "skip=true" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          # Create new branch
          git checkout -b "$BRANCH"

          # Remove old docs and copy new
          rm -rf subcog
          cp -r ../docs subcog

          # Ensure .nojekyll exists at root
          touch .nojekyll

          # Stage all changes first (new files are untracked, git diff won't see them)
          git add -A

          # Check for changes
          if git diff --staged --quiet; then
            echo "No changes to deploy"
            echo "skip=true" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          echo "skip=false" >> "$GITHUB_OUTPUT"

          # Commit changes
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git commit -m "docs: update subcog documentation

          Source: ${{ github.repository }}@${SOURCE_SHA}"

          # Push branch
          git push origin "$BRANCH"

      - name: Create Pull Request
        if: steps.update.outputs.skip != 'true'
        env:
          GH_TOKEN: ${{ secrets.ZIRCOTE_GH_PAGES_TOKEN }}
          BRANCH: ${{ steps.update.outputs.branch }}
          SOURCE_SHA: ${{ github.sha }}
        run: |
          cd site

          # Check if PR already exists
          EXISTING_PR=$(gh pr list --head "$BRANCH" --json number --jq '.[0].number' 2>/dev/null || echo "")

          if [ -n "$EXISTING_PR" ]; then
            echo "PR #$EXISTING_PR already exists for branch $BRANCH"
            exit 0
          fi

          # Create PR
          gh pr create \
            --title "docs: update subcog documentation" \
            --body "## Summary

          Automated documentation update from [subcog](https://github.com/${{ github.repository }}).

          **Source commit:** [${{ github.repository }}@${SOURCE_SHA:0:7}](https://github.com/${{ github.repository }}/commit/${SOURCE_SHA})

          ## Changes

          Updates the \`/subcog/\` directory with the latest rustdoc output.

          ---
          ðŸ¤– Generated by [subcog docs workflow](https://github.com/${{ github.repository }}/actions/workflows/docs.yml)" \
            --base main \
            --head "$BRANCH"
