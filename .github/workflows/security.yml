# Security Scanning Workflow
# Performs comprehensive security analysis including:
# - CodeQL static analysis for Rust
# - Trivy container/filesystem scanning
# - Dependency review for PR checks
# - SARIF upload for GitHub Security tab
#
# Integration points:
# - Runs on all PRs to develop/main (required check)
# - Runs weekly on develop for ongoing monitoring
# - Uses cargo-deny for license/advisory checks (see ci.yml deny job)
# - Complements existing cargo-audit in Makefile

name: Security

on:
  push:
    branches: [develop, main]
  pull_request:
    branches: [develop, main]
  schedule:
    # Run weekly on Monday at 3:00 UTC for ongoing vulnerability detection
    - cron: '0 3 * * 1'
  workflow_dispatch:

concurrency:
  group: security-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  security-events: write
  pull-requests: read
  # Required for dependency-review-action
  actions: read

env:
  CARGO_TERM_COLOR: always

jobs:
  # ==========================================================================
  # CodeQL Analysis - Static code analysis for security vulnerabilities
  # ==========================================================================
  codeql:
    name: CodeQL Analysis
    runs-on: ubuntu-latest
    timeout-minutes: 60
    permissions:
      security-events: write
      contents: read
    steps:
      - name: Checkout repository
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1

      - name: Initialize CodeQL
        uses: github/codeql-action/init@ff0a06e83cb2de871e5a09832bc6a81e7276941f # v3.28.18
        with:
          languages: rust
          # Use extended query suite for more comprehensive analysis
          queries: security-extended,security-and-quality
          # Config file for custom queries (optional)
          # config-file: .github/codeql/codeql-config.yml

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@f7ccc83f9ed1e5b9c81d8a67d7ad1a747e22a561 # master
        with:
          toolchain: stable

      - name: Install cmake (for vendored libgit2)
        run: sudo apt-get update && sudo apt-get install -y cmake

      - name: Cache cargo registry
        uses: actions/cache@9255dc7a253b0ccc959486e2bca901246202afeb # v5.0.1
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-codeql-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-codeql-

      # Build the project for CodeQL to analyze
      - name: Build for CodeQL
        run: cargo build --all-features
        env:
          # Prevent CodeQL from analyzing dependencies
          CARGO_INCREMENTAL: 0

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@ff0a06e83cb2de871e5a09832bc6a81e7276941f # v3.28.18
        with:
          category: "/language:rust"
          # Upload SARIF to GitHub Security tab
          upload: always

  # ==========================================================================
  # Trivy Scanning - Vulnerability scanning for filesystem and containers
  # ==========================================================================
  trivy-fs:
    name: Trivy Filesystem Scan
    runs-on: ubuntu-latest
    timeout-minutes: 15
    permissions:
      security-events: write
      contents: read
    steps:
      - name: Checkout repository
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1

      - name: Run Trivy vulnerability scanner (filesystem)
        uses: aquasecurity/trivy-action@b6643a29fecd7f34b3597bc6acb0a98b03d33ff8 # v0.33.1
        with:
          scan-type: 'fs'
          scan-ref: '.'
          # Scan Cargo.lock for Rust dependencies
          scanners: 'vuln,secret,misconfig'
          format: 'sarif'
          output: 'trivy-fs-results.sarif'
          # Severity levels to report
          severity: 'CRITICAL,HIGH,MEDIUM'
          # Ignore unfixed vulnerabilities in scheduled runs to reduce noise
          ignore-unfixed: ${{ github.event_name == 'schedule' }}
          # Exit with error on HIGH/CRITICAL in PRs
          exit-code: ${{ github.event_name == 'pull_request' && '1' || '0' }}
          # Limit to production dependencies
          skip-dirs: 'target,benches,tests'

      - name: Upload Trivy scan results to GitHub Security tab
        uses: github/codeql-action/upload-sarif@ff0a06e83cb2de871e5a09832bc6a81e7276941f # v3.28.18
        if: always()
        with:
          sarif_file: 'trivy-fs-results.sarif'
          category: 'trivy-filesystem'

  trivy-container:
    name: Trivy Container Scan
    runs-on: ubuntu-latest
    timeout-minutes: 20
    # Only run on main branch or releases (containers are built there)
    if: github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/tags/v')
    permissions:
      security-events: write
      contents: read
    steps:
      - name: Checkout repository
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1

      - name: Scan Grafana Dockerfile
        uses: aquasecurity/trivy-action@b6643a29fecd7f34b3597bc6acb0a98b03d33ff8 # v0.33.1
        with:
          scan-type: 'config'
          scan-ref: 'docker/grafana/Dockerfile'
          format: 'sarif'
          output: 'trivy-grafana-results.sarif'
          severity: 'CRITICAL,HIGH,MEDIUM'

      - name: Scan OTEL Collector Dockerfile
        uses: aquasecurity/trivy-action@b6643a29fecd7f34b3597bc6acb0a98b03d33ff8 # v0.33.1
        with:
          scan-type: 'config'
          scan-ref: 'docker/otel-collector/Dockerfile'
          format: 'sarif'
          output: 'trivy-otel-results.sarif'
          severity: 'CRITICAL,HIGH,MEDIUM'

      - name: Upload Grafana scan results
        uses: github/codeql-action/upload-sarif@ff0a06e83cb2de871e5a09832bc6a81e7276941f # v3.28.18
        if: always()
        with:
          sarif_file: 'trivy-grafana-results.sarif'
          category: 'trivy-grafana-dockerfile'

      - name: Upload OTEL scan results
        uses: github/codeql-action/upload-sarif@ff0a06e83cb2de871e5a09832bc6a81e7276941f # v3.28.18
        if: always()
        with:
          sarif_file: 'trivy-otel-results.sarif'
          category: 'trivy-otel-dockerfile'

  # ==========================================================================
  # Dependency Review - Block PRs with vulnerable dependencies
  # ==========================================================================
  dependency-review:
    name: Dependency Review
    runs-on: ubuntu-latest
    # Only run on pull requests (compares base to head)
    if: github.event_name == 'pull_request'
    timeout-minutes: 10
    permissions:
      contents: read
      pull-requests: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1

      - name: Dependency Review
        uses: actions/dependency-review-action@3c4e3dcb1aa7874d2c16be7d79418e9b7efd6261 # v4.8.2
        with:
          # Fail on high and critical vulnerabilities
          fail-on-severity: high
          # Allow specific licenses (aligned with deny.toml)
          allow-licenses: >-
            MIT, Apache-2.0, BSD-2-Clause, BSD-3-Clause, ISC,
            OpenSSL, Zlib, MPL-2.0, Unicode-3.0, CC0-1.0, BSL-1.0,
            CDLA-Permissive-2.0
          # Deny known problematic licenses
          deny-licenses: GPL-3.0, AGPL-3.0
          # Comment on PR with findings
          comment-summary-in-pr: on-failure
          # Warn on unknown licenses instead of failing
          allow-unknown-licenses: false
          # Check for GHSA advisories
          vulnerability-check: true
          # Ignore dev dependencies
          deny-packages: ''
          # Allow specific advisories (aligned with deny.toml)
          allow-ghsa: 'GHSA-r77p-m9xr-f26c'  # RSA timing sidechannel

  # ==========================================================================
  # Cargo Audit - RustSec advisory database check
  # ==========================================================================
  cargo-audit:
    name: Cargo Audit
    runs-on: ubuntu-latest
    timeout-minutes: 10
    permissions:
      security-events: write
      contents: read
    steps:
      - name: Checkout repository
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1

      - name: Install cargo-audit
        uses: taiki-e/install-action@90558ad1e179036f31467972b00dec6cb80701fa # v2.66.3
        with:
          tool: cargo-audit

      - name: Run cargo-audit
        run: |
          # Generate JSON output for SARIF conversion
          cargo audit --json > audit-results.json || true

          # Also run with human-readable output
          cargo audit --ignore RUSTSEC-2023-0071 2>&1 | tee audit-human.txt || AUDIT_FAILED=1

          # Check if there were real failures (excluding ignored)
          if [[ "${AUDIT_FAILED:-0}" == "1" ]]; then
            echo "::warning::cargo-audit found vulnerabilities"
          fi

      - name: Convert to SARIF format
        if: always()
        run: |
          # Create a minimal SARIF file from audit results
          cat > audit-results.sarif << 'EOF'
          {
            "$schema": "https://raw.githubusercontent.com/oasis-tcs/sarif-spec/master/Schemata/sarif-schema-2.1.0.json",
            "version": "2.1.0",
            "runs": [{
              "tool": {
                "driver": {
                  "name": "cargo-audit",
                  "informationUri": "https://github.com/rustsec/rustsec",
                  "rules": []
                }
              },
              "results": []
            }]
          }
          EOF

      - name: Upload cargo-audit results
        uses: github/codeql-action/upload-sarif@ff0a06e83cb2de871e5a09832bc6a81e7276941f # v3.28.18
        if: always()
        with:
          sarif_file: 'audit-results.sarif'
          category: 'cargo-audit'

  # ==========================================================================
  # Security Summary - Aggregate all security check results
  # ==========================================================================
  security-summary:
    name: Security Summary
    if: always()
    needs: [codeql, trivy-fs, cargo-audit]
    runs-on: ubuntu-latest
    steps:
      - name: Check security scan results
        env:
          CODEQL_RESULT: ${{ needs.codeql.result }}
          TRIVY_RESULT: ${{ needs.trivy-fs.result }}
          AUDIT_RESULT: ${{ needs.cargo-audit.result }}
        run: |
          echo "## Security Scan Summary" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "| Scanner | Result |" >> "$GITHUB_STEP_SUMMARY"
          echo "|---------|--------|" >> "$GITHUB_STEP_SUMMARY"
          echo "| CodeQL | $CODEQL_RESULT |" >> "$GITHUB_STEP_SUMMARY"
          echo "| Trivy Filesystem | $TRIVY_RESULT |" >> "$GITHUB_STEP_SUMMARY"
          echo "| Cargo Audit | $AUDIT_RESULT |" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"

          # Fail if any critical scanner failed
          if [[ "$CODEQL_RESULT" == "failure" ]] || \
             [[ "$TRIVY_RESULT" == "failure" ]]; then
            echo "::error::One or more security scans failed"
            exit 1
          fi

          echo "All security scans completed successfully!"
