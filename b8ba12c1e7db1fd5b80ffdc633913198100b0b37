---
created_at: 1767212425
domain: global
id: learnings_bff7ef64-30fd-4429-8229-230945d7294a
namespace: learnings
status: active
tags:
- prometheus
- push-gateway
- metrics
- debugging
- claude-code-hooks
- reqwest
updated_at: 1767212425
---
# Prometheus Push Gateway Metrics Debugging

## Problem
Metrics pushed to Prometheus push gateway via reqwest were returning 200 OK but not persisting in the gateway.

## Root Causes Found

### 1. Claude Code Hook Input Format
The `UserPromptSubmit` hook was extracting the prompt from wrong JSON path:
- **Wrong**: `input_json.get("prompt")`
- **Correct**: `input_json.get("hookSpecificData").and_then(|v| v.get("userPromptContent"))`

### 2. Push Gateway Metric Family Replacement
Push gateway replaces metrics at the **family** level, not individual time series:
- When `PostToolUse` pushed `hook_duration_ms`, it replaced ALL `hook_duration_ms` metrics from `UserPromptSubmit`
- Solution: Use different instance labels for each hook type
- Pattern: `hooks-{hook_type}` (e.g., `hooks-user-prompt-submit`, `hooks-post-tool-use`)

### 3. POST vs PUT for Push Gateway
- **PUT**: Replaces ALL metrics for the grouping key (job + instance)
- **POST**: Adds/updates individual metric families while preserving others
- Default should be POST for multi-component scenarios

## Debugging Techniques

1. **Payload inspection**: Save payload to file and push with curl to isolate issue
2. **Binary search**: Split payload in half to find problematic metrics
3. **Instance isolation**: Test with unique instance labels to avoid collision
4. **Direct push test**: `cat payload | curl --data-binary @-` vs `curl --data-binary @file`

## Files Modified
- `src/hooks/user_prompt.rs` - Fixed prompt extraction path
- `src/observability/metrics.rs` - Default POST, trailing newline, proper logging
- `src/main.rs` - Per-hook-type instance labels