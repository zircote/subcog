---
title: "Three-Layer Storage Architecture"
description: "Implements storage as three independent pluggable layers (Persistence, Index, Vector) with trait-based abstractions for flexible backend selection."
type: adr
category: architecture
tags:
  - storage
  - persistence
  - indexing
  - vector-search
  - traits
  - pluggable-backends
status: published
created: 2025-12-28
updated: 2026-01-04
author: Claude (Architect)
project: subcog
technologies:
  - sqlite
  - postgresql
  - redis
  - usearch
  - pgvector
audience:
  - developers
  - architects
confidence: high
completeness: complete
---

# ADR-0002: Three-Layer Storage Architecture

## Status

Accepted

## Context

Memory storage requires three distinct capabilities:

1. **Persistence**: Authoritative, durable storage
2. **Index**: Fast metadata and full-text search
3. **Vector**: Embedding storage and KNN similarity search

A monolithic storage backend would couple these concerns and limit flexibility.

## Decision

We will implement storage as three independent, pluggable layers with trait-based abstraction:

```rust
trait PersistenceBackend { /* ... */ }
trait IndexBackend { /* ... */ }
trait VectorBackend { /* ... */ }
```

Each layer can have multiple implementations:

- **Persistence**: Git Notes, PostgreSQL, Filesystem
- **Index**: SQLite (FTS5), PostgreSQL, Redis (RediSearch)
- **Vector**: usearch, pgvector, Redis

## Consequences

### Positive

- Backend selection via configuration
- Mix-and-match deployment options
- Independent scaling of each layer
- Easier testing with mock implementations
- Future backends without code changes

### Negative

- More complex architecture
- Cross-layer coordination overhead
- Potential consistency challenges
- Configuration complexity

## Decision Outcome

The flexibility to support git notes for local development while allowing PostgreSQL+pgvector for team deployments is essential. The complexity is justified by the deployment flexibility.

## More Information

- **Date:** 2025-12-28
- **Source:** SPEC-2025-12-28: Subcog Rust Rewrite
