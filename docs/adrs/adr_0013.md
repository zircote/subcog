---
title: "In-Memory Topic Index"
description: "Use in-memory HashMap with RwLock for topic-to-memory mapping, rebuilt at startup and updated on capture."
type: adr
category: indexing
tags:
  - topic-index
  - in-memory
  - hashmap
  - rwlock
  - caching
status: published
created: 2025-12-30
updated: 2026-01-04
author: Claude (Architect)
project: subcog
technologies:
  - rust
audience:
  - developers
  - architects
confidence: high
completeness: complete
---

# ADR-0013: In-Memory Topic Index

## Status

Accepted

## Context

To support topic-based memory surfacing (`subcog://topics/{topic}`), we need to maintain a topic â†’ memory mapping. Options:

1. Build index on every request
2. Store index in SQLite alongside memories
3. Maintain in-memory HashMap, rebuild on startup

## Decision

We will use an **in-memory HashMap with RwLock**, rebuilt at MCP server startup and updated on capture:

```rust
topics: Arc<RwLock<HashMap<String, Vec<MemoryId>>>>
```

## Consequences

### Positive

- Very fast lookups (<5ms)
- No additional database schema changes
- Simple implementation
- Automatic refresh on capture

### Negative

- Lost on server restart (rebuilt from memories)
- Memory overhead for large projects
- RwLock contention on updates

### Neutral

- Index rebuild is async at startup
- Typical project has <100 topics

## Options Considered

### Option 1: On-demand building

Build index on first topic request

**Cons:**
- Unpredictable first-request latency

### Option 2: SQLite persistence

Store topic index in database

**Cons:**
- Overkill for volatile derived data

## More Information

- **Date:** 2025-12-30
- **Source:** SPEC-2025-12-30-001: Proactive Memory Surfacing

## Audit

### 2026-01-04

**Status:** Compliant

**Findings:**

| Finding | Files | Lines | Assessment |
|---------|-------|-------|------------|
| In-memory topic index uses Arc<RwLock<HashMap>> | `src/services/topic_index.rs` | L35-L56 | compliant |

**Summary:** Topic index is maintained in-memory with RwLock-protected HashMaps.

**Action Required:** None
