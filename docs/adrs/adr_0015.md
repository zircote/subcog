---
title: "Token Budget for Injected Memories"
description: "Implement token budget (default 4000) with content truncation to prevent context bloat when injecting memories."
type: adr
category: performance
tags:
  - token-budget
  - truncation
  - context-management
  - memory-injection
status: published
created: 2025-12-30
updated: 2026-01-04
author: Claude (Architect)
project: subcog
audience:
  - developers
  - architects
confidence: high
completeness: complete
---

# ADR-0015: Token Budget for Injected Memories

## Status

Accepted

## Context

Injecting too many memories or too much content can overwhelm the assistant's context and slow processing. We need to limit injected content.

## Decision

We will implement a **token budget** with content truncation:

- Default: 4000 tokens for injected memories
- Memory content truncated to ~200 chars for preview
- Full content available via memory URN if needed

## Consequences

### Positive

- Prevents context bloat
- Consistent injection size
- Memory URN provides access to full content

### Negative

- Truncation may hide important details
- Fixed budget may not be optimal for all cases

### Neutral

- Budget configurable via `max_tokens`

## More Information

- **Date:** 2025-12-30
- **Source:** SPEC-2025-12-30-001: Proactive Memory Surfacing

## Audit

### 2026-01-04

**Status:** Partial

**Findings:**

| Finding | Files | Lines | Assessment |
|---------|-------|-------|------------|
| Default max_tokens=4000 and preview_length=200 configured | `src/hooks/search_context.rs` | L13-L38 | compliant |
| Injected memories are assembled without token budget enforcement | `src/hooks/search_context.rs` | L381-L418 | gap |

**Summary:** Token budget and preview length are configured, but injected memory assembly does not enforce max token budget.

**Action Required:** Apply max token budget when assembling injected memory context.

### 2026-01-04

**Status:** Compliant

**Findings:**

| Finding | Files | Lines | Assessment |
|---------|-------|-------|------------|
| Injected memory assembly enforces max token budget with truncation | `src/hooks/search_context.rs` | L412-L437 | compliant |

**Summary:** Injected memories now respect the configured token budget and truncate previews as needed.

**Action Required:** None
