---
title: "Regex-Based Code Block Detection"
description: "Use regex pattern with LazyLock for static compilation to detect fenced code blocks, consistent with existing codebase patterns."
type: adr
category: parsing
tags:
  - regex
  - code-blocks
  - markdown
  - lazylock
  - rust
status: published
created: 2026-01-01
updated: 2026-01-04
author: Claude (Architect)
project: subcog
technologies:
  - rust
  - regex
audience:
  - developers
  - architects
confidence: high
completeness: complete
---

# ADR-0028: Regex-Based Code Block Detection

## Status

Accepted

## Context

How to detect fenced code blocks in content?

- Full Markdown parser (pulldown-cmark, comrak)
- Custom regex pattern
- Character-by-character state machine

## Decision

We will use a **regex pattern** with LazyLock for static compilation.

```rust
static CODE_BLOCK_PATTERN: LazyLock<Regex> = LazyLock::new(|| {
    Regex::new(r"```([a-zA-Z0-9_-]*)\n([\s\S]*?)```")
        .expect("static regex: code block pattern")
});
```

## Consequences

### Positive

- Consistent with existing codebase patterns (secrets.rs, pii.rs)
- No new dependencies
- Fast execution (<1ms)
- Simple to understand and maintain

### Negative

- May not handle all edge cases (nested, escaped)
- Less robust than full parser

## Options Considered

### Option 1: pulldown-cmark

Full Markdown parser

**Cons:**
- Heavyweight for this use case

### Option 2: State machine

**Cons:**
- More control, but more code to maintain

## More Information

- **Date:** 2026-01-01
- **Source:** SPEC-2026-01-01-002: Prompt Variable Context-Aware Extraction
