---
title: "User Frontmatter Preservation"
description: "Merge LLM enrichment with user-provided frontmatter, filling gaps while preserving user values to respect user intent."
type: adr
category: architecture
tags:
  - merge
  - frontmatter
  - user-values
  - enrichment
status: accepted
created: 2026-01-01
updated: 2026-01-04
author: Claude (Architect)
project: subcog
audience:
  - developers
  - architects
confidence: high
completeness: complete
---

# ADR-0030: User Frontmatter Preservation

## Status

Accepted

## Context

When user provides partial frontmatter, how should enrichment behave?

- Overwrite all with LLM output
- Merge (LLM fills gaps, user values preserved)
- Skip enrichment entirely if any frontmatter present

## Decision Drivers

### Primary Decision Drivers

1. **Respect User Intent**: If a user explicitly provides a value, they likely have a reason. The system should not override their choices.

2. **Partial Metadata Support**: Users should be able to provide some metadata (e.g., tags) and let the LLM fill in the rest (e.g., description).

3. **No Surprises**: Users should see their provided values in the final output, not LLM-generated replacements.

### Secondary Decision Drivers

1. **Incremental Enhancement**: Users can start with minimal metadata and progressively enhance by removing fields and re-enriching.

2. **Debugging Clarity**: When user values are preserved, it is clear which metadata came from the user vs. the LLM.

## Decision

We will **merge** - LLM fills gaps, but user-provided values are never overwritten.

## Consequences

### Positive

- User intent is respected
- Can provide partial metadata and let LLM complete
- No surprises (user sees their values preserved)

### Negative

- More complex merge logic
- User can't "reset" to LLM-suggested values without removing their values

### Neutral

- Merge behavior is documented and predictable

## Considered Options

### Option 1: Overwrite All with LLM Output

**Description**: Replace all frontmatter with LLM-generated metadata.

**Advantages**: Simple implementation, consistent output.

**Disadvantages**: Loses user-provided values, disrespects user intent.

### Option 2: Merge with User Precedence (Selected)

**Description**: Use user values when present, LLM values to fill gaps.

**Advantages**: Respects user intent, enables partial metadata workflows.

**Disadvantages**: More complex merge logic.

### Option 3: Skip Enrichment if Any Frontmatter Present

**Description**: If the user provides any frontmatter, skip LLM enrichment entirely.

**Advantages**: Clear either/or behavior.

**Disadvantages**: Users cannot get partial enrichment, all-or-nothing approach.

## Implementation

```rust
fn merge_enrichment(user: &PartialMetadata, llm: &EnrichmentResult) -> EnrichmentResult {
    EnrichmentResult {
        description: user.description.clone().unwrap_or_else(|| llm.description.clone()),
        tags: if user.tags.is_empty() { llm.tags.clone() } else { user.tags.clone() },
        variables: merge_variables(&user.variables, &llm.variables),
    }
}
```

## More Information

- **Date:** 2026-01-01
- **Source:** SPEC-2026-01-01-002: Prompt Variable Context-Aware Extraction

## Audit

### 2026-01-04

**Status:** Compliant

**Findings:**

| Finding | Files | Lines | Assessment |
|---------|-------|-------|------------|
| merge_with_user preserves user description/tags/variables | `src/services/prompt_enrichment.rs` | L246-L275 | compliant |

**Summary:** User-provided frontmatter is preserved when merging enrichment results.

**Action Required:** None
