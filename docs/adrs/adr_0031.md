---
title: "Graceful Fallback Strategy"
description: "Fall back to basic variable extraction when LLM enrichment fails, ensuring save never fails due to enrichment issues."
type: adr
category: resilience
tags:
  - graceful-fallback
  - error-handling
  - llm-enrichment
  - degradation
status: published
created: 2026-01-01
updated: 2026-01-04
author: Claude (Architect)
project: subcog
audience:
  - developers
  - architects
confidence: high
completeness: complete
---

# ADR-0031: Graceful Fallback Strategy

## Status

Accepted

## Context

What happens when LLM enrichment fails (unavailable, timeout, invalid response)?

## Decision Drivers

### Primary Decision Drivers

1. **Reliability**: Save operations must never fail due to optional enrichment features
2. **Offline Support**: Users working offline should still have functional prompt saving
3. **Consistency**: Behavior should align with subcog's overall degradation philosophy

### Secondary Decision Drivers

1. **User Awareness**: Users should be informed when degraded mode is active
2. **Debuggability**: Fallback reasons should be logged for troubleshooting
3. **Quality Preservation**: Basic metadata should still be useful even without LLM enrichment

## Considered Options

### Option 1: Graceful Fallback to Basic Extraction (Selected)

**Description**: When LLM enrichment fails, fall back to basic variable extraction (name + required=true).

**Advantages**:
- Save never fails due to enrichment
- User can still work offline
- Consistent with subcog's degradation philosophy

**Disadvantages**:
- Silent degradation may surprise users
- Metadata quality inconsistent when LLM flaky

### Option 2: Fail on Enrichment Error

**Description**: Propagate enrichment errors to the caller, failing the save operation.

**Advantages**:
- Clear error handling
- User knows exactly what failed

**Disadvantages**:
- Blocks users when LLM unavailable
- Poor offline experience
- Enrichment is optional, shouldn't block core functionality

### Option 3: Queue for Later Enrichment

**Description**: Save without enrichment, queue for background enrichment when LLM available.

**Advantages**:
- Eventually consistent enrichment
- No blocking on save

**Disadvantages**:
- Complex queue management
- Stale enrichment data possible
- Over-engineering for current requirements

## Decision

We will use **graceful fallback** to basic variable extraction (name + required=true).

## Consequences

### Positive

- Save never fails due to enrichment
- User can still work offline
- Consistent with subcog's degradation philosophy

### Negative

- Silent degradation may surprise users
- Metadata quality inconsistent when LLM flaky

### Neutral

- Requires clear user feedback about enrichment status
- Monitoring needed to detect persistent enrichment failures

## Implementation

```rust
// Log the fallback reason
tracing::warn!("Enrichment failed, using fallback: {}", error);

// Return basic metadata
EnrichmentResult::basic_from_variables(variables)
```

## User Feedback

- CLI shows: "Note: LLM enrichment unavailable, using basic metadata"
- MCP response includes: `"enrichment_status": "fallback"`

## More Information

- **Date:** 2026-01-01
- **Source:** SPEC-2026-01-01-002: Prompt Variable Context-Aware Extraction

## Audit

### 2026-01-04

**Status:** Compliant

**Findings:**

| Finding | Files | Lines | Assessment |
|---------|-------|-------|------------|
| enrich_with_fallback returns basic metadata on failure | `src/services/prompt_enrichment.rs` | L359-L376 | compliant |

**Summary:** LLM enrichment failures fall back to basic variable extraction.

**Action Required:** None
