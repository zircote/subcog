---
title: "Lazy Load Embedding Model"
description: "Use OnceLock lazy loading for embedding model to preserve <10ms cold start requirement while accepting slower first embed."
type: adr
category: performance
tags:
  - lazy-loading
  - oncelock
  - cold-start
  - embeddings
status: published
created: 2026-01-02
updated: 2026-01-04
author: Claude (Architect)
project: subcog
technologies:
  - rust
audience:
  - developers
  - architects
confidence: high
completeness: complete
---

# ADR-0033: Lazy Load Embedding Model

## Status

Accepted

## Context

The all-MiniLM-L6-v2 model takes ~1-2 seconds to load from disk. Loading at application start would violate the <10ms cold start requirement.

Options considered:
1. **Eager loading** - Load model at startup
2. **Lazy loading** - Load on first embed call
3. **Background loading** - Load in separate thread at startup
4. **Pre-compiled binary** - Embed model in binary

## Decision

We will use **lazy loading** via `OnceLock<TextEmbedding>` singleton.

```rust
static MODEL: OnceLock<TextEmbedding> = OnceLock::new();

fn get_model() -> Result<&'static TextEmbedding> {
    MODEL.get_or_try_init(|| TextEmbedding::try_new(...))
}
```

## Consequences

### Positive

- Cold start remains <10ms
- Simple implementation
- Thread-safe via `OnceLock`

### Negative

- First embed call is slow (~2s)
- User may perceive lag on first capture/recall

## Options Considered

| Option | Cold Start | First Embed | Complexity |
|--------|------------|-------------|------------|
| Eager | ~2s | ~30ms | Low |
| Lazy | <10ms | ~2s | Low |
| Background | <10ms | Varies | High |
| Pre-compiled | <10ms | ~30ms | Very High |

## Decision Outcome

Lazy loading preserves the cold start requirement while keeping implementation simple. The trade-off of slower first embed is acceptable.

Mitigations:
- Add progress indicator for first embed
- Consider background warm-up in MCP server mode
- Document expected first-use latency

## More Information

- **Date:** 2026-01-02
- **Source:** SPEC-2026-01-02: Memory System Critical Fixes
