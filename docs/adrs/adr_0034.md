---
title: "Three-Layer Storage Synchronization Strategy"
description: "Use synchronous best-effort writes with Git Notes as authoritative source, tolerating index/vector failures for reliability."
type: adr
category: storage
tags:
  - synchronization
  - best-effort
  - git-notes
  - eventual-consistency
status: superseded
created: 2026-01-02
updated: 2026-01-04
author: Claude (Architect)
project: subcog
related:
  - adr_0047.md
audience:
  - developers
  - architects
confidence: high
completeness: complete
---

# ADR-0034: Three-Layer Storage Synchronization Strategy

## Status

Superseded by ADR-0047

## Context

Subcog has three storage layers:
1. **Persistence** (Git Notes) - Authoritative, version-controlled
2. **Index** (SQLite FTS5) - Text search
3. **Vector** (usearch) - Semantic search

Currently, capture only writes to Git Notes. Index and vector are never updated.

## Decision Drivers

### Primary Decision Drivers

1. **Data Integrity**: Git Notes as authoritative source ensures data can always be recovered
2. **Reliability**: Capture should not fail due to secondary storage issues
3. **Simplicity**: Synchronous writes are easier to reason about than async queues

### Secondary Decision Drivers

1. **Performance**: Best-effort writes avoid blocking on slow secondary stores
2. **Observability**: Failures in secondary stores should be logged for monitoring
3. **Recoverability**: Index/vector can be rebuilt from Git Notes if needed

## Considered Options

### Option 1: Synchronous All-or-Nothing

**Description**: Transaction across all three storage layers.

**Advantages**:
- Strong consistency

**Disadvantages**:
- Slow
- Complex
- Single failure blocks entire operation

### Option 2: Synchronous Best-Effort (Selected)

**Description**: Write all layers, tolerate failures in index/vector.

**Advantages**:
- Fast
- Reliable (primary store must succeed)
- Simple error handling

**Disadvantages**:
- Briefly inconsistent
- Need monitoring for failures

### Option 3: Async Eventual Consistency

**Description**: Queue writes, process asynchronously.

**Advantages**:
- Fastest capture

**Disadvantages**:
- Complex queue management
- Hard to debug

### Option 4: Git Notes Only + Rebuild

**Description**: Only persist to Git Notes, rebuild index/vector on demand.

**Advantages**:
- Simplest capture path

**Disadvantages**:
- No search until rebuild
- Rebuild can be slow

## Decision

We will use **synchronous best-effort** with Git Notes as authoritative.

```
Capture Flow:
1. Generate embedding (fail fast)
2. Write Git Notes (authoritative, must succeed)
3. Index in SQLite (best effort)
4. Upsert to vector (best effort)
```

## Consequences

### Positive

- Capture never fails due to index/vector issues
- Git Notes remain the source of truth
- Index/vector can be rebuilt from Git Notes
- Simpler error handling

### Negative

- Briefly inconsistent (memory in Git but not searchable)
- Need monitoring for index/vector failures
- May need periodic reconciliation

### Neutral

- Mitigations include logging warnings, adding `subcog repair` command, and monitoring for persistent failures

## Options Comparison

| Option | Consistency | Performance | Complexity |
|--------|-------------|-------------|------------|
| All-or-nothing | Strong | Slow | High |
| Best-effort | Eventual | Fast | Medium |
| Async | Eventual | Fastest | High |
| Rebuild | None until rebuild | Fast capture | Low |

## Decision Outcome

Best-effort synchronization provides good balance of reliability and simplicity. Git Notes as authoritative source enables rebuild capability.

Mitigations:
- Log warnings for index/vector failures
- Add `subcog repair` command to reconcile
- Monitor for persistent failures

## More Information

- **Date:** 2026-01-02
- **Source:** SPEC-2026-01-02: Memory System Critical Fixes
- **Note:** This ADR predates ADR-0047 (Remove Git-Notes). Post ADR-0047, SQLite becomes the authoritative persistence layer.

## Audit

### 2026-01-04

**Status:** Violated

**Findings:**

| Finding | Files | Lines | Assessment |
|---------|-------|-------|------------|
| Capture storage layers list SQLite index and vector only | `src/services/capture.rs` | L16-L22 | violation |

**Summary:** Capture path documents index/vector storage only; Git Notes authoritative layer is absent.

**Action Required:** Update the ADR or reintroduce Git Notes as authoritative storage.

### 2026-01-04

**Status:** Unverifiable

**Findings:**

| Finding | Files | Lines | Assessment |
|---------|-------|-------|------------|
| ADR-0047 supersedes git-notes persistence, so this decision is no longer applicable | `docs/adrs/adr_0047.md` | L29-L53 | gap |

**Summary:** This ADR is superseded by ADR-0047; git-notes are removed, so compliance is not applicable to current code.

**Action Required:** None
