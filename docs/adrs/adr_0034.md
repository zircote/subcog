---
title: "Three-Layer Storage Synchronization Strategy"
description: "Use synchronous best-effort writes with Git Notes as authoritative source, tolerating index/vector failures for reliability."
type: adr
category: storage
tags:
  - synchronization
  - best-effort
  - git-notes
  - eventual-consistency
status: published
created: 2026-01-02
updated: 2026-01-04
author: Claude (Architect)
project: subcog
related:
  - adr_0047.md
audience:
  - developers
  - architects
confidence: high
completeness: complete
---

# ADR-0034: Three-Layer Storage Synchronization Strategy

## Status

Accepted

## Context

Subcog has three storage layers:
1. **Persistence** (Git Notes) - Authoritative, version-controlled
2. **Index** (SQLite FTS5) - Text search
3. **Vector** (usearch) - Semantic search

Currently, capture only writes to Git Notes. Index and vector are never updated.

Options considered:
1. **Synchronous all-or-nothing** - Transaction across all three
2. **Synchronous best-effort** - Write all, tolerate failures
3. **Async eventual consistency** - Queue writes, process async
4. **Git Notes only + rebuild** - Only persist, rebuild index/vector on demand

## Decision

We will use **synchronous best-effort** with Git Notes as authoritative.

```
Capture Flow:
1. Generate embedding (fail fast)
2. Write Git Notes (authoritative, must succeed)
3. Index in SQLite (best effort)
4. Upsert to vector (best effort)
```

## Consequences

### Positive

- Capture never fails due to index/vector issues
- Git Notes remain the source of truth
- Index/vector can be rebuilt from Git Notes
- Simpler error handling

### Negative

- Briefly inconsistent (memory in Git but not searchable)
- Need monitoring for index/vector failures
- May need periodic reconciliation

## Options Considered

| Option | Consistency | Performance | Complexity |
|--------|-------------|-------------|------------|
| All-or-nothing | Strong | Slow | High |
| Best-effort | Eventual | Fast | Medium |
| Async | Eventual | Fastest | High |
| Rebuild | None until rebuild | Fast capture | Low |

## Decision Outcome

Best-effort synchronization provides good balance of reliability and simplicity. Git Notes as authoritative source enables rebuild capability.

Mitigations:
- Log warnings for index/vector failures
- Add `subcog repair` command to reconcile
- Monitor for persistent failures

## More Information

- **Date:** 2026-01-02
- **Source:** SPEC-2026-01-02: Memory System Critical Fixes
- **Note:** This ADR predates ADR-0047 (Remove Git-Notes). Post ADR-0047, SQLite becomes the authoritative persistence layer.
