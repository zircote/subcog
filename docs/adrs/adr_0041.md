---
title: "Conditional Git Notes in CaptureService"
description: "Add use_git_notes flag to CaptureService for conditional git notes storage, enabling user-scope operation."
type: adr
category: architecture
tags:
  - capture-service
  - git-notes
  - conditional
  - user-scope
status: superseded
created: 2026-01-02
updated: 2026-01-04
author: Claude (Architect)
project: subcog
related:
  - adr_0047.md
audience:
  - developers
  - architects
confidence: high
completeness: complete
---

# ADR-0041: Conditional Git Notes in CaptureService

## Status

Superseded by ADR-0047

## Context

CaptureService currently always attempts to store to git notes. For user-scope, git notes are unavailable.

## Decision Drivers

### Primary Decision Drivers

1. **Code Reuse**: Avoid duplicating capture logic across different storage modes
2. **Simplicity**: Single service class with flag is simpler than multiple classes
3. **Testability**: Existing tests should continue to work without modification

### Secondary Decision Drivers

1. **API Clarity**: Flag name should clearly document its purpose
2. **Factory Responsibility**: Service factories must set flag correctly
3. **Minimal Change**: Keep code changes localized to capture service

## Considered Options

### Option 1: Add use_git_notes Flag (Selected)

**Description**: Add `use_git_notes: bool` flag to CaptureService.

**Advantages**:
- No new service class to maintain
- Existing tests continue to work
- Easy to understand behavior switch
- Minimal code change (single field addition)
- Clear semantics (flag name self-documents behavior)
- Reuses existing embedding, indexing, vector logic

**Disadvantages**:
- Slight complexity increase in `capture()` method
- Must ensure flag is set correctly by factories

### Option 2: Separate UserCaptureService Class

**Description**: Create separate `UserCaptureService` class.

**Advantages**:
- Clean separation of concerns

**Disadvantages**:
- Code duplication
- Maintenance burden
- Two classes to test

### Option 3: Pluggable Persistence Layer

**Description**: Make persistence layer fully pluggable via trait.

**Advantages**:
- Maximum flexibility

**Disadvantages**:
- Over-engineering for current requirements
- Complex trait hierarchy

## Decision

We will add a `use_git_notes: bool` flag to CaptureService.

## Consequences

### Positive

- No new service class to maintain
- Existing tests continue to work
- Easy to understand behavior switch
- Minimal code change (single field addition)
- Clear semantics (flag name self-documents behavior)
- Reuses existing embedding, indexing, vector logic

### Negative

- Slight complexity increase in `capture()` method
- Must ensure flag is set correctly by factories

### Neutral

- Future refactoring may extract common logic if more storage modes are added

## Decision Outcome

A simple flag provides the necessary flexibility without introducing architectural complexity.

## More Information

- **Date:** 2026-01-02
- **Source:** SPEC-2026-01-02: User-Scope Storage Fallback
- **Note:** This ADR predates ADR-0047 (Remove Git-Notes). Post ADR-0047, git notes are removed entirely.

## Audit

### 2026-01-04

**Status:** Violated

**Findings:**

| Finding | Files | Lines | Assessment |
|---------|-------|-------|------------|
| Capture storage layers do not reference git-notes | `src/services/capture.rs` | L16-L29 | violation |

**Summary:** CaptureService has no conditional git-notes flag or implementation.

**Action Required:** Implement use_git_notes flag or update ADR-0041.

### 2026-01-04

**Status:** Unverifiable

**Findings:**

| Finding | Files | Lines | Assessment |
|---------|-------|-------|------------|
| ADR-0047 removes git-notes persistence, superseding conditional git-notes logic | `docs/adrs/adr_0047.md` | L29-L53 | gap |

**Summary:** This ADR is superseded by ADR-0047; conditional git-notes storage is no longer applicable.

**Action Required:** None
