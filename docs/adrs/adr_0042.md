---
title: "Factory Method Pattern for ServiceContainer"
description: "Use factory methods (for_repo, for_user, from_current_dir_or_user) on ServiceContainer for context-specific instantiation."
type: adr
category: architecture
tags:
  - factory-method
  - service-container
  - design-pattern
  - api-design
status: published
created: 2026-01-02
updated: 2026-01-04
author: Claude (Architect)
project: subcog
audience:
  - developers
  - architects
confidence: high
completeness: complete
---

# ADR-0042: Factory Method Pattern for ServiceContainer

## Status

Accepted

## Context

Need to create ServiceContainer instances for different contexts (project vs user).

## Decision Drivers

### Primary Decision Drivers

1. **API Consistency**: Maintain consistency with existing `for_repo()` and `from_current_dir()` methods
2. **Discoverability**: IDE autocomplete should show all available factory methods
3. **Self-Documentation**: Method names should describe their intent clearly

### Secondary Decision Drivers

1. **Simplicity**: Avoid unnecessary abstraction layers
2. **Testability**: Factory methods should be easy to test
3. **Extensibility**: Pattern should allow adding new factory methods easily

## Considered Options

### Option 1: Factory Methods on ServiceContainer (Selected)

**Description**: Add factory methods `for_repo()`, `for_user()`, `from_current_dir_or_user()` directly on ServiceContainer.

**Advantages**:
- Consistent with existing API (`for_repo()` and `from_current_dir()` already exist)
- Easy to use and understand
- IDE autocomplete shows all options
- Self-documenting method names describe intent
- No new types (avoids adding builder/factory classes)

**Disadvantages**:
- ServiceContainer impl block grows larger
- Each factory has its own initialization logic

### Option 2: Builder Pattern

**Description**: Use a ServiceContainerBuilder with fluent API.

**Advantages**:
- Flexible configuration

**Disadvantages**:
- Overkill for 3-4 factory methods
- More verbose usage

### Option 3: Separate Factory Class

**Description**: Create ServiceContainerFactory class.

**Advantages**:
- Separates construction from service logic

**Disadvantages**:
- Adds indirection without benefit
- Another type to maintain

### Option 4: Configuration-Based Instantiation

**Description**: Pass configuration object to constructor.

**Advantages**:
- Single entry point

**Disadvantages**:
- Too implicit
- Harder to debug
- Less discoverable

## Decision

We will use **factory methods** on ServiceContainer: `for_repo()`, `for_user()`, `from_current_dir_or_user()`.

## Consequences

### Positive

- Consistent with existing API (`for_repo()` and `from_current_dir()` already exist)
- Easy to use and understand
- IDE autocomplete shows all options
- Self-documenting method names describe intent
- No new types (avoids adding builder/factory classes)

### Negative

- ServiceContainer impl block grows larger
- Each factory has its own initialization logic

### Neutral

- May refactor to builder pattern if more configuration options are needed in future

## Decision Outcome

Factory methods provide a clean, discoverable API that follows established patterns in the codebase.

## More Information

- **Date:** 2026-01-02
- **Source:** SPEC-2026-01-02: User-Scope Storage Fallback

## Audit

### 2026-01-04

**Status:** Compliant

**Findings:**

| Finding | Files | Lines | Assessment |
|---------|-------|-------|------------|
| Factory methods for repo/user/fallback are implemented | `src/services/mod.rs` | L211-L377 | compliant |

**Summary:** ServiceContainer exposes factory methods for repo, user, and fallback contexts.

**Action Required:** None
