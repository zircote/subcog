---
title: "Fallback Order in from_current_dir_or_user()"
description: "Try project scope first via from_current_dir(), fall back to user scope on error for automatic scope selection."
type: adr
category: architecture
tags:
  - fallback
  - user-scope
  - project-scope
  - service-container
status: accepted
created: 2026-01-02
updated: 2026-01-04
author: Claude (Architect)
project: subcog
audience:
  - developers
  - architects
confidence: high
completeness: complete
---

# ADR-0046: Fallback Order in `from_current_dir_or_user()`

## Status

Accepted

## Context

When automatically selecting scope, need to decide priority order.

Options considered:
1. Try project first, fall back to user
2. Try user first, fall back to project
3. Check `.git` explicitly, then decide
4. Always prefer user scope

## Decision Drivers

### Primary Decision Drivers

1. **Backward Compatibility**: Existing git repo users expect project scope by default
2. **Intuitive Behavior**: If user is in a git repo, they likely want project-scoped memories
3. **Simplicity**: Simple implementation reduces bugs and maintenance burden

### Secondary Decision Drivers

1. **Debuggability**: Clear fallback chain is easy to understand and debug
2. **Explicit Fallback**: Only uses user scope when project is impossible

## Considered Options

### Option 1: Project First, Fall Back to User (Selected)

**Description**: Try `from_current_dir()` first, catch error and fall back to user scope.

**Advantages**:
- No change in behavior for existing git repo users
- Clear fallback chain
- Easy to understand and debug

**Disadvantages**:
- Slight overhead trying project first (negligible)
- Error might be logged before fallback

### Option 2: User First, Fall Back to Project

**Description**: Try user scope first, only use project if explicitly requested.

**Advantages**:
- Consistent behavior regardless of directory

**Disadvantages**:
- Would break existing workflows in git repos
- Less intuitive for project-based work

### Option 3: Explicit `.git` Check

**Description**: Check for `.git` directory explicitly before deciding scope.

**Advantages**:
- No error handling needed

**Disadvantages**:
- Same result as Option 1, more code
- Duplicates logic already in `from_current_dir()`

### Option 4: Always User Scope

**Description**: Always use user scope, ignore project context.

**Advantages**:
- Simplest implementation

**Disadvantages**:
- Defeats purpose of project-scoped memories
- Major breaking change

## Decision

We will try **project scope first** via `from_current_dir()`, fall back to user scope on error.

## Consequences

### Positive

- No change in behavior for existing git repo users
- Clear fallback chain
- Easy to understand and debug
- Preserves existing behavior (project scope is default when available)
- Simple implementation (just catch the error)
- Git repo = project intent (if user is in git repo, they likely want project memories)
- Explicit fallback (only uses user scope when project is impossible)

### Negative

- Slight overhead trying project first (negligible)
- Error might be logged before fallback

### Neutral

- Project-first fallback maintains backward compatibility while enabling user-scope for non-git contexts

## More Information

- **Date:** 2026-01-02
- **Source:** SPEC-2026-01-02: User-Scope Storage Fallback

## Audit

### 2026-01-04

**Status:** Compliant

**Findings:**

| Finding | Files | Lines | Assessment |
|---------|-------|-------|------------|
| Fallback order is project then user | `src/services/mod.rs` | L364-L376 | compliant |

**Summary:** from_current_dir_or_user tries project scope first, then user scope.

**Action Required:** None
