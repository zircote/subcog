---
title: "Remove Git-Notes Storage Layer"
description: "Remove git-notes as persistence layer entirely due to critical capture overwrite bug and design mismatch."
type: adr
category: storage
tags:
  - git-notes
  - storage
  - breaking-change
  - simplification
status: published
created: 2026-01-03
updated: 2026-01-04
author: Claude (Architect)
project: subcog
related:
  - adr_0006.md
  - adr_0048.md
technologies:
  - rust
  - sqlite
audience:
  - developers
  - architects
confidence: high
completeness: complete
---

# ADR-0047: Remove Git-Notes Storage Layer

## Status

Accepted

**Supersedes:** [ADR-0006: Git Notes for Project-Scope Persistence](adr_0006.md)

## Context

The current storage architecture uses git-notes as the primary persistence layer for project-scoped memories. However, this approach has fundamental problems:

1. **Critical Capture Bug**: The `CaptureService::capture()` method at `src/services/capture.rs:198` calls `notes.add_to_head()` which uses `force=true` at `src/git/notes.rs:113`. This causes **every new memory to overwrite the previous one** - only one memory can exist at a time.

2. **Design Mismatch**: Git notes are designed to annotate specific commits, not to store arbitrary key-value data. The current approach fights against git's design by trying to attach unrelated data to HEAD.

3. **Workaround Complexity**: A proper fix would require creating unique marker blobs for each memory, essentially implementing a content-addressed store on top of git - adding significant complexity.

4. **Sync Issues**: Git notes require special fetch/push refspecs, and conflicts during sync can lose data silently.

## Decision

We will **remove git-notes as a persistence layer entirely**.

- Delete `src/git/notes.rs` and related git-notes code
- Remove git2 crate dependency if it's only used for notes
- Route all captures through SQLite/PostgreSQL backends
- Use `directories` crate for platform-specific user data paths

## Consequences

### Positive

- Eliminates the critical capture overwrite bug
- Simplifies codebase by ~500 LOC
- Removes complex sync logic
- Single source of truth for all memories

### Negative

- Loses the "memories travel with the repo" feature
- Requires explicit backup strategy for user data directory
- Breaking change for existing workflows (mitigated by fresh start decision)

### Neutral

- Git remains useful for source context detection, just not storage

## Alternatives Considered

1. **Fix git-notes with unique blobs**: Create a marker blob for each memory and attach notes to that blob. Rejected because it fights against git's design and adds complexity.

2. **Use git-notes only for export**: Keep git-notes as a "publish" mechanism rather than primary storage. Rejected as premature - can be added later if needed.

3. **Switch to git-backed file storage**: Store memories as files in `.subcog/` directory and commit them. Rejected because it pollutes repository history and requires special handling for ignored directories.

## More Information

- **Date:** 2026-01-03
- **Source:** SPEC-2026-01-03-001: Storage Architecture Simplification
- **Related ADRs:** [ADR-0006](adr_0006.md) (superseded), [ADR-0048](adr_0048.md)

## Audit

### 2026-01-04

**Status:** Compliant

**Findings:**

| Finding | Files | Lines | Assessment |
|---------|-------|-------|------------|
| Persistence backends do not include git-notes | `src/storage/persistence/mod.rs` | L1-L7 | compliant |
| Sync service notes SQLite as authoritative and no remote sync | `src/services/sync.rs` | L3-L6 | compliant |

**Summary:** Git-notes persistence is removed; storage relies on SQLite and other backends.

**Action Required:** None
