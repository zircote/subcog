---
title: "Remove Git-Notes Storage Layer"
description: "Remove git-notes as persistence layer entirely due to critical capture overwrite bug and design mismatch."
type: adr
category: storage
tags:
  - git-notes
  - storage
  - breaking-change
  - simplification
status: accepted
created: 2026-01-03
updated: 2026-01-04
author: Claude (Architect)
project: subcog
related:
  - adr_0006.md
  - adr_0048.md
technologies:
  - rust
  - sqlite
audience:
  - developers
  - architects
confidence: high
completeness: complete
---

# ADR-0047: Remove Git-Notes Storage Layer

## Status

Accepted

**Supersedes:** [ADR-0006: Git Notes for Project-Scope Persistence](adr_0006.md)

## Context

The current storage architecture uses git-notes as the primary persistence layer for project-scoped memories. However, this approach has fundamental problems:

1. **Critical Capture Bug**: The `CaptureService::capture()` method at `src/services/capture.rs:198` calls `notes.add_to_head()` which uses `force=true` at `src/git/notes.rs:113`. This causes **every new memory to overwrite the previous one** - only one memory can exist at a time.

2. **Design Mismatch**: Git notes are designed to annotate specific commits, not to store arbitrary key-value data. The current approach fights against git's design by trying to attach unrelated data to HEAD.

3. **Workaround Complexity**: A proper fix would require creating unique marker blobs for each memory, essentially implementing a content-addressed store on top of git - adding significant complexity.

4. **Sync Issues**: Git notes require special fetch/push refspecs, and conflicts during sync can lose data silently.

## Decision Drivers

### Primary Decision Drivers

1. **Data Integrity**: The capture overwrite bug causes data loss, which is unacceptable
2. **Architectural Simplicity**: Fighting against git's design creates ongoing maintenance burden
3. **Reliability**: Silent data loss during sync is a critical failure mode

### Secondary Decision Drivers

1. **Codebase Reduction**: Removing git-notes simplifies the codebase by ~500 LOC
2. **Single Source of Truth**: Having one authoritative storage location reduces confusion

## Considered Options

### Option 1: Remove Git-Notes Entirely (Selected)

**Description**: Delete `src/git/notes.rs` and related git-notes code. Route all captures through SQLite/PostgreSQL backends.

**Advantages**:
- Eliminates the critical capture overwrite bug
- Simplifies codebase by ~500 LOC
- Removes complex sync logic
- Single source of truth for all memories

**Disadvantages**:
- Loses the "memories travel with the repo" feature
- Requires explicit backup strategy for user data directory
- Breaking change for existing workflows

### Option 2: Fix Git-Notes with Unique Blobs

**Description**: Create a marker blob for each memory and attach notes to that blob instead of HEAD.

**Advantages**:
- Preserves "memories travel with repo" feature

**Disadvantages**:
- Fights against git's design
- Adds significant complexity
- Still has sync conflict issues

### Option 3: Use Git-Notes Only for Export

**Description**: Keep git-notes as a "publish" mechanism rather than primary storage.

**Advantages**:
- Could enable sharing memories via git

**Disadvantages**:
- Premature - can be added later if needed
- Adds complexity without immediate benefit

### Option 4: Git-Backed File Storage

**Description**: Store memories as files in `.subcog/` directory and commit them.

**Advantages**:
- Memories travel with repo via normal git mechanisms

**Disadvantages**:
- Pollutes repository history
- Requires special handling for ignored directories
- Merge conflicts on memory files

## Decision

We will **remove git-notes as a persistence layer entirely**.

- Delete `src/git/notes.rs` and related git-notes code
- Remove git2 crate dependency if it's only used for notes
- Route all captures through SQLite/PostgreSQL backends
- Use `directories` crate for platform-specific user data paths

## Consequences

### Positive

- Eliminates the critical capture overwrite bug
- Simplifies codebase by ~500 LOC
- Removes complex sync logic
- Single source of truth for all memories

### Negative

- Loses the "memories travel with the repo" feature
- Requires explicit backup strategy for user data directory
- Breaking change for existing workflows (mitigated by fresh start decision)

### Neutral

- Git remains useful for source context detection, just not storage

## More Information

- **Date:** 2026-01-03
- **Source:** SPEC-2026-01-03-001: Storage Architecture Simplification
- **Related ADRs:** [ADR-0006](adr_0006.md) (superseded), [ADR-0048](adr_0048.md)

## Audit

### 2026-01-04

**Status:** Compliant

**Findings:**

| Finding | Files | Lines | Assessment |
|---------|-------|-------|------------|
| Persistence backends do not include git-notes | `src/storage/persistence/mod.rs` | L1-L7 | compliant |
| Sync service notes SQLite as authoritative and no remote sync | `src/services/sync.rs` | L3-L6 | compliant |

**Summary:** Git-notes persistence is removed; storage relies on SQLite and other backends.

**Action Required:** None
