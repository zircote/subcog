---
title: "Consolidate to User-Level Storage with Faceting"
description: "Consolidate to user-level storage with project/branch/path facets for simpler architecture and cross-project learning."
type: adr
category: storage
tags:
  - storage
  - facets
  - user-scope
  - consolidation
status: accepted
created: 2026-01-03
updated: 2026-01-04
author: Claude (Architect)
project: subcog
related:
  - adr_0047.md
  - adr_0049.md
technologies:
  - rust
  - sqlite
audience:
  - developers
  - architects
confidence: high
completeness: complete
---

# ADR-0048: Consolidate to User-Level Storage with Faceting

## Status

Accepted

## Context

The current architecture has three storage tiers with complex routing:

```
org/     -> Shared PostgreSQL (configured, rarely used)
project/ -> Git notes per repo (BROKEN)
user/    -> ~/.config/subcog/ (works)
```

This creates several problems:
- Complexity in deciding where to store/retrieve
- Per-repository storage prevents cross-project learning
- Backup and sync story is complicated (3 locations)

## Decision Drivers

### Primary Decision Drivers

1. **Cross-Project Learning**: Per-repository storage prevents learning from patterns across projects
2. **Backup Simplicity**: Single location is easier to back up than three
3. **Mental Model**: Users should not need to understand storage tier routing

### Secondary Decision Drivers

1. **Reduced Complexity**: Fewer code paths means fewer bugs
2. **Flexible Querying**: Faceted search is more powerful than tier-based retrieval

## Considered Options

### Option 1: Consolidate to User-Level with Facets (Selected)

**Description**: Single storage location with project/branch/path facets for filtering.

**Advantages**:
- Single location to backup
- Cross-project learning enabled via faceted queries
- Simpler mental model for users
- Reduced codebase complexity

**Disadvantages**:
- Memories don't automatically travel with repository clones
- Requires careful facet normalization (remote URL variations)

### Option 2: Keep Three Tiers, Fix Git-Notes

**Description**: Maintain current architecture but fix the git-notes bug.

**Advantages**:
- Memories travel with repo

**Disadvantages**:
- Complex routing logic remains
- Cross-project learning still impossible
- Three backup locations

### Option 3: Two Tiers (User + Org)

**Description**: Remove project tier, keep user and org.

**Advantages**:
- Simpler than three tiers

**Disadvantages**:
- Still two locations to manage
- Org tier rarely used

## Decision

We will **consolidate to user-level storage with project/branch/path facets**.

- Single storage location:
  - Linux: `~/.local/share/subcog/`
  - macOS: `~/Library/Application Support/subcog/`
  - Windows: `%APPDATA%\subcog\`
- Auto-detect facets from git context when capturing
- Query by facets instead of switching storage tiers

Facet fields added to Memory struct:
```rust
pub struct Memory {
    // ... existing fields ...
    pub project_id: Option<String>,  // Normalized git remote URL
    pub branch: Option<String>,       // Current branch name
    pub file_path: Option<String>,    // Relative path from repo root
}
```

## Consequences

### Positive

- Single location to backup
- Cross-project learning enabled via faceted queries
- Simpler mental model for users
- Reduced codebase complexity

### Negative

- Memories don't automatically travel with repository clones
- Requires careful facet normalization (remote URL variations)

### Neutral

- Org-scope can be added later as a separate configured backend

## More Information

- **Date:** 2026-01-03
- **Source:** SPEC-2026-01-03-001: Storage Architecture Simplification
- **Related ADRs:** [ADR-0047](adr_0047.md), [ADR-0049](adr_0049.md)

## Audit

### 2026-01-04

**Status:** Violated

**Findings:**

| Finding | Files | Lines | Assessment |
|---------|-------|-------|------------|
| Memory struct lacks project_id/branch/file_path facets | `src/models/memory.rs` | L43-L68 | violation |
| SQLite schema has no facet columns | `src/storage/index/sqlite.rs` | L231-L240 | violation |

**Summary:** Memory model and schema lack project/branch/path facets required by the ADR.

**Action Required:** Add facet fields to Memory and persist them in SQLite, or revise ADR-0048.

### 2026-01-04

**Status:** Compliant

**Findings:**

| Finding | Files | Lines | Assessment |
|---------|-------|-------|------------|
| Memory model includes project_id/branch/file_path facets | `src/models/memory.rs` | L43-L73 | compliant |
| SQLite memories table includes facet columns | `src/storage/index/sqlite.rs` | L234-L262 | compliant |

**Summary:** Facet fields are present in the memory model and persisted to SQLite.

**Action Required:** None
