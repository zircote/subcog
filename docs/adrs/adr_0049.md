---
title: "Inline Facet Columns (Denormalized)"
description: "Use inline (denormalized) facet columns on the memories table for simpler queries and better performance."
type: adr
category: storage
tags:
  - storage
  - database-design
  - denormalization
  - facets
status: accepted
created: 2026-01-03
updated: 2026-01-04
author: Claude (Architect)
project: subcog
related:
  - adr_0048.md
technologies:
  - sqlite
  - sql
audience:
  - developers
  - architects
confidence: high
completeness: complete
---

# ADR-0049: Inline Facet Columns (Denormalized)

## Status

Accepted

## Context

There are two approaches to storing facets:

1. **Normalized**: Separate `projects` and `branches` tables with foreign keys
2. **Denormalized**: Inline columns directly on the `memories` table

## Decision Drivers

### Primary Decision Drivers

1. **Query Simplicity**: Denormalized queries require no joins
2. **Performance**: Direct filtering is faster than join-based filtering
3. **Flexibility**: Facets can be NULL for non-git contexts without foreign key issues

### Secondary Decision Drivers

1. **Garbage Collection**: Easier to tombstone by facet without cascading deletes
2. **Schema Evolution**: Adding new facets is simpler without relationship tables

## Considered Options

### Option 1: Denormalized Inline Columns (Selected)

**Description**: Add project_id, branch, file_path columns directly to memories table.

**Advantages**:
- Simpler queries (no joins required)
- Better query performance (direct filtering without join overhead)
- Easier garbage collection (`UPDATE SET status='tombstoned' WHERE branch=?`)
- Facets can be NULL for non-git contexts
- No referential integrity issues

**Disadvantages**:
- Storage overhead from repeated project_id strings
- No enforced consistency for project names

### Option 2: Normalized with Foreign Keys

**Description**: Create separate projects and branches tables with foreign keys.

**Advantages**:
- No string duplication
- Enforced referential integrity
- Normalized form

**Disadvantages**:
- Join overhead on every query
- Foreign key complexity for NULL cases
- Cascading delete complexity

## Decision

We will use **inline (denormalized) facet columns** on the memories table.

```sql
ALTER TABLE memories ADD COLUMN project_id TEXT;
ALTER TABLE memories ADD COLUMN branch TEXT;
ALTER TABLE memories ADD COLUMN file_path TEXT;

CREATE INDEX idx_memories_project ON memories(project_id);
CREATE INDEX idx_memories_branch ON memories(project_id, branch);
CREATE INDEX idx_memories_path ON memories(file_path);
```

## Consequences

### Positive

- Simpler queries (no joins required)
- Better query performance (direct filtering without join overhead)
- Easier garbage collection (`UPDATE SET status='tombstoned' WHERE branch=?`)
- Facets can be NULL for non-git contexts
- No referential integrity issues

### Negative

- Storage overhead from repeated project_id strings
- No enforced consistency for project names

### Neutral

- Mitigations available: Project IDs are typically <100 chars, overhead is minimal; normalization can be applied at query time if needed

## More Information

- **Date:** 2026-01-03
- **Source:** SPEC-2026-01-03-001: Storage Architecture Simplification
- **Related ADRs:** [ADR-0048](adr_0048.md)

## Audit

### 2026-01-04

**Status:** Violated

**Findings:**

| Finding | Files | Lines | Assessment |
|---------|-------|-------|------------|
| Memories table schema lacks facet columns | `src/storage/index/sqlite.rs` | L231-L240 | violation |

**Summary:** SQLite memories table does not include denormalized facet columns.

**Action Required:** Add facet columns (project_id, branch, file_path) and update queries.

### 2026-01-04

**Status:** Compliant

**Findings:**

| Finding | Files | Lines | Assessment |
|---------|-------|-------|------------|
| Denormalized facet columns present in SQLite schema | `src/storage/index/sqlite.rs` | L234-L262 | compliant |
| Facet indexes created for project/branch/file_path | `src/storage/index/sqlite.rs` | L334-L345 | compliant |

**Summary:** SQLite schema now includes denormalized facet columns and indexes.

**Action Required:** None
