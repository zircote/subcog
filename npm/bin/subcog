#!/usr/bin/env node
/**
 * @fileoverview Wrapper script for the subcog binary
 *
 * This script locates and executes the platform-specific binary.
 * It's used as the npm bin entry point to enable cross-platform support.
 */

'use strict';

const { spawn } = require('child_process');
const path = require('path');
const fs = require('fs');

const BINARY_NAME = 'subcog';

// Find the binary path
function getBinaryPath() {
  const binDir = __dirname;

  // Check for custom binary path override
  if (process.env.SUBCOG_BINARY_PATH) {
    const customPath = process.env.SUBCOG_BINARY_PATH;
    if (fs.existsSync(customPath)) {
      return customPath;
    }
    console.error(`Custom binary not found: ${customPath}`);
    process.exit(1);
  }

  // Platform-specific binary name
  const binaryName = process.platform === 'win32' ? `${BINARY_NAME}.exe` : BINARY_NAME;
  const binaryPath = path.join(binDir, binaryName);

  if (fs.existsSync(binaryPath)) {
    return binaryPath;
  }

  // Binary not found - provide helpful error
  console.error(`
Error: subcog binary not found at ${binaryPath}

This usually means the postinstall script failed to download the binary.
Please try:

1. Reinstalling the package:
   npm uninstall @zircote/subcog && npm install @zircote/subcog

2. Installing manually:
   - Download from: https://github.com/zircote/subcog/releases
   - Set SUBCOG_BINARY_PATH environment variable to the binary location

3. Building from source:
   cargo install --git https://github.com/zircote/subcog.git

For more help, visit: https://github.com/zircote/subcog/issues
`);
  process.exit(1);
}

// Execute the binary with all arguments
function main() {
  const binaryPath = getBinaryPath();
  const args = process.argv.slice(2);

  const child = spawn(binaryPath, args, {
    stdio: 'inherit',
    // Pass through all environment variables
    env: process.env,
  });

  child.on('error', (error) => {
    console.error(`Failed to execute subcog: ${error.message}`);
    process.exit(1);
  });

  child.on('close', (code) => {
    process.exit(code ?? 0);
  });
}

main();
